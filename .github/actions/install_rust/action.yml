name: Bootstrap rust installation
description: Setup rust environment and its components, also caching the build results.

inputs:
  extra_rust_toolchains:
    description: "Extra toolchains to install, but aren't used by default"
    required: false
  github_token:
    description: "Github token to use for authentication"
    required: false

runs:
  using: "composite"
  steps:
    - uses: moonrepo/setup-rust@v1
      name: Install Rust toolchain and binaries
      with:
        cache: false
        inherit-toolchain: true
        # Install additional non-default toolchains (for rustfmt for example), NOP if input omitted.
        channel: ${{ inputs.extra_rust_toolchains }}
      env:
        GITHUB_TOKEN: ${{ inputs.github_token }}

    - name: Download cargo tools artifacts
      uses: namespace-actions/download-artifact@v2
      continue-on-error: true
      with:
        name: cargo-tools-artifacts
        path: /tmp/cargo-tools-artifacts
        github-token: ${{ inputs.github_token }}
        run-id: null

    - name: Restore cargo tools
      continue-on-error: true
      shell: bash
      run: |
        echo "Restoring cargo tools artifacts from /tmp/cargo-tools-artifacts..."
        if [ -d /tmp/cargo-tools-artifacts/bin ]; then
          chmod +x /tmp/cargo-tools-artifacts/bin/*
          cp -r /tmp/cargo-tools-artifacts/bin/* ~/.cargo/bin/
          echo "Binaries restored successfully"
        fi
        if [ -f /tmp/cargo-tools-artifacts/.crates.toml ]; then
          cp /tmp/cargo-tools-artifacts/.crates.toml ~/.cargo/
          echo "Crate.toml restored successfully"
        fi
        if [ -f /tmp/cargo-tools-artifacts/.crates2.json ]; then
          cp /tmp/cargo-tools-artifacts/.crates2.json ~/.cargo/
          echo "Crates2.json restored successfully"
        fi

    - name: Install cargo tools
      shell: bash
      run: ./scripts/install_cargo_tools.sh

    # This installation is _not_ cached, but takes a couple seconds: it's downloading prepackaged binaries.
    - name: Install Anvil
      uses: foundry-rs/foundry-toolchain@v1
      with:
        version: v1.5.1
