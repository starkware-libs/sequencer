name: Papyrus-CI

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - edited # for when the PR title is edited
    paths:
      - ".github/workflows/papyrus_ci.yml"
      - "deployments/images/base/Dockerfile"
      - "Cargo.toml"
      - "Cargo.lock"
      - "crates/papyrus**/**"
      - "crates/apollo_starknet_client/**"
      - "scripts/dependencies.sh"

env:
  RUSTFLAGS: "-D warnings -C link-arg=-fuse-ld=lld"

# On PR events, cancel existing CI runs on this same PR for this workflow.
# Also, create different concurrency groups for different pushed commits, on push events.
concurrency:
  group: >
    ${{ github.workflow }}-
    ${{ github.ref }}-
    ${{ github.event_name == 'pull_request' && 'PR' || github.sha }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  integration-test:
    runs-on: namespace-profile-medium-ubuntu-24-04-amd64
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/bootstrap
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
      - run: >
          cargo test
          --test latency_histogram
          --test gateway_integration_test
          --test feeder_gateway_integration_test
          -- --include-ignored --skip test_gw_integration_testnet

  random-table-test:
    runs-on: namespace-profile-medium-ubuntu-24-04-amd64
    steps:
      - uses: actions/checkout@v4
      # run this job only if the path 'crates/apollo_storage/src/db/**' is changed, because it takes around 2 minutes.
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          # The 'base' and 'ref' parameters are set to be able to run the job in a 'merge_group' event. in a 'pull_request' event
          # those parameters are ignored.
          base: ${{ github.event.merge_group.base_ref}}
          ref: ${{ github.event.merge_group.head_ref }}
          filters: |
            target_directory:
              - 'crates/apollo_storage/src/db/**'
      - uses: ./.github/actions/bootstrap
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
      # repeat this job 32 times. this is a random test for part of the code that may cause a corrupted database.
      - run: for run in {1..32}; do cargo test -p apollo_storage -- --include-ignored common_prefix_compare_with_simple_table_random; done
        if: steps.changes.outputs.target_directory == 'true'
