# Local Monitoring Stack

### Requirements:
- Python3
- docker >= 27.3.1
    - installation guide: https://docs.docker.com/engine/install/ubuntu/
    - Do **not** choose the `Docker Desktop` installation option but rather the `apt` one.

### Setup:
```bash
python3 -m venv monitoring_venv
source monitoring_venv/bin/activate
```

### Start up:
To run with docker cache:
```bash
./deployments/monitoring/deploy_local_stack.sh up -d
```

To force build (useful to enforce applying changes in docker file settings):
```bash
./deployments/monitoring/deploy_local_stack.sh up -d --build
```

## This will deploy a local stack of:
- Sequencer Node Setup
- Sequencer Node (using a config generated by **Sequencer Node Setup**.)
- Sequencer Node Simulator
- Dummy Cende Recorder
- Prometheus
- Grafana (Using: [dev_grafana.json](../../crates/apollo_dashboard/resources/dev_grafana.json) dashboard.)

Once the node starts emitting logs, one can ctrl+c to move the run to the background.

## Open Grafana:
After Grafana starts running, it can be viewed by accessing http://localhost:3000 in a web browser.

## Troubleshooting
- If encountering `Failed to deploy the monitoring stack locally`, verify the docker version is adequate:
    ```
    docker --version
    docker compose --version
    ```
- If you encouter failures due to `memory allocation failed`:
    - Increase your swap size if it's very small (<8GB)
    - If you installed `Docker Desktop` it limits the amount of memeory avaialble to docker. Prefer installing docker using `apt` as mentioned above. As a workaround you can go into `Docker Desktop` settings -> `Resources` -> `Advanced` and increase the memory and swap limits.

## Shutdown & Cleanup:
```bash
./deployments/monitoring/deploy_local_stack.sh down -v
deactivate
rm -rf monitoring_venv
```
## Making changes:
After making changes, update dev_grafana.json by running:
```bash
cargo run --bin sequencer_dashboard_generator
```

