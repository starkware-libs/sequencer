{"version":3,"file":"compiler.js","sourceRoot":"","sources":["../src/compiler.ts"],"names":[],"mappings":"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","sourcesContent":["import * as fs from 'node:fs';\nimport * as path from 'node:path';\nimport * as chalk from 'chalk';\nimport * as log4js from 'log4js';\nimport * as ts from 'typescript';\n\nimport { Assembler } from './assembler';\nimport { findDependencyDirectory } from './common/find-utils';\nimport { Emitter } from './emitter';\nimport { JsiiDiagnostic } from './jsii-diagnostic';\nimport { ProjectInfo } from './project-info';\nimport { WARNINGSCODE_FILE_NAME } from './transforms/deprecation-warnings';\nimport { TypeScriptConfig, TypeScriptConfigValidationRuleSet } from './tsconfig';\nimport { BASE_COMPILER_OPTIONS, convertForJson } from './tsconfig/compiler-options';\nimport { TypeScriptConfigValidator } from './tsconfig/tsconfig-validator';\nimport { ValidationError } from './tsconfig/validator';\nimport * as utils from './utils';\n\nconst LOG = log4js.getLogger('jsii/compiler');\nexport const DIAGNOSTICS = 'diagnostics';\nexport const JSII_DIAGNOSTICS_CODE = 9999;\n\nexport interface CompilerOptions {\n  /** The information about the project to be built */\n  projectInfo: ProjectInfo;\n  /** Whether the compiler should watch for changes or just compile once */\n  watch?: boolean;\n  /** Whether to detect and generate TypeScript project references */\n  projectReferences?: boolean;\n  /** Whether to fail when a warning is emitted */\n  failOnWarnings?: boolean;\n  /** Whether to strip deprecated members from emitted artifacts */\n  stripDeprecated?: boolean;\n  /** The path to an allowlist of FQNs to strip if stripDeprecated is set */\n  stripDeprecatedAllowListFile?: string;\n  /** Whether to add warnings for deprecated elements */\n  addDeprecationWarnings?: boolean;\n  /**\n   * The name of the tsconfig file to generate.\n   * Cannot be used at the same time as `typeScriptConfig`.\n   * @default \"tsconfig.json\"\n   */\n  generateTypeScriptConfig?: string;\n  /**\n   * The name of the tsconfig file to use.\n   * Cannot be used at the same time as `generateTypeScriptConfig`.\n   * @default - generate the tsconfig file\n   */\n  typeScriptConfig?: string;\n  /**\n   * The ruleset to validate the provided tsconfig file against.\n   * Can only be used when `typeScriptConfig` is provided.\n   * @default TypeScriptConfigValidationRuleSet.STRICT - if `typeScriptConfig` is provided\n   */\n  validateTypeScriptConfig?: TypeScriptConfigValidationRuleSet;\n  /**\n   * Whether to compress the assembly\n   * @default false\n   */\n  compressAssembly?: boolean;\n}\n\nexport class Compiler implements Emitter {\n  private readonly system: ts.System;\n  private readonly compilerHost: ts.CompilerHost;\n  private readonly userProvidedTypeScriptConfig: boolean;\n  private readonly tsconfig: TypeScriptConfig;\n  private rootFiles: string[] = [];\n  private readonly configPath: string;\n  private readonly projectRoot: string;\n\n  public constructor(private readonly options: CompilerOptions) {\n    if (options.generateTypeScriptConfig != null && options.typeScriptConfig != null) {\n      throw new utils.JsiiError(\n        'Cannot use `generateTypeScriptConfig` and `typeScriptConfig` together. Provide only one of them.',\n      );\n    }\n\n    this.projectRoot = this.options.projectInfo.projectRoot;\n    const configFileName = options.typeScriptConfig ?? options.generateTypeScriptConfig ?? 'tsconfig.json';\n    this.configPath = path.join(this.projectRoot, configFileName);\n    this.userProvidedTypeScriptConfig = Boolean(options.typeScriptConfig);\n\n    this.system = {\n      ...ts.sys,\n      getCurrentDirectory: () => this.projectRoot,\n      createDirectory: (pth) => ts.sys.createDirectory(path.resolve(this.projectRoot, pth)),\n      deleteFile: ts.sys.deleteFile && ((pth) => ts.sys.deleteFile!(path.join(this.projectRoot, pth))),\n      fileExists: (pth) => ts.sys.fileExists(path.resolve(this.projectRoot, pth)),\n      getFileSize: ts.sys.getFileSize && ((pth) => ts.sys.getFileSize!(path.resolve(this.projectRoot, pth))),\n      readFile: (pth, encoding) => ts.sys.readFile(path.resolve(this.projectRoot, pth), encoding),\n      watchFile:\n        ts.sys.watchFile &&\n        ((pth, callback, pollingInterval, watchOptions) =>\n          ts.sys.watchFile!(path.resolve(this.projectRoot, pth), callback, pollingInterval, watchOptions)),\n      writeFile: (pth, data, writeByteOrderMark) =>\n        ts.sys.writeFile(path.resolve(this.projectRoot, pth), data, writeByteOrderMark),\n    };\n\n    this.tsconfig = this.configureTypeScript();\n    this.compilerHost = ts.createIncrementalCompilerHost(this.tsconfig.compilerOptions, this.system);\n  }\n\n  /**\n   * Compiles the configured program.\n   *\n   * @param files can be specified to override the standard source code location logic. Useful for example when testing \"negatives\".\n   */\n  public emit(...files: string[]): ts.EmitResult {\n    this.prepareForBuild(...files);\n    return this.buildOnce();\n  }\n\n  /**\n   * Watches for file-system changes and dynamically recompiles the project as needed. In non-blocking mode, this\n   * returns the TypeScript watch handle for the application to use.\n   *\n   * @internal\n   */\n  public async watch(opts: NonBlockingWatchOptions): Promise<ts.Watch<ts.BuilderProgram>>;\n  /**\n   * Watches for file-system changes and dynamically recompiles the project as needed. In blocking mode, this results\n   * in a never-resolving promise.\n   */\n  public async watch(): Promise<never>;\n  public async watch(opts?: NonBlockingWatchOptions): Promise<ts.Watch<ts.BuilderProgram> | never> {\n    this.prepareForBuild();\n\n    const host = ts.createWatchCompilerHost(\n      this.configPath,\n      {\n        ...this.tsconfig.compilerOptions,\n        noEmitOnError: false,\n      },\n      this.system,\n      ts.createEmitAndSemanticDiagnosticsBuilderProgram,\n      opts?.reportDiagnostics,\n      opts?.reportWatchStatus,\n      this.tsconfig.watchOptions,\n    );\n    if (!host.getDefaultLibLocation) {\n      throw new Error('No default library location was found on the TypeScript compiler host!');\n    }\n    const orig = host.afterProgramCreate;\n    // This is a callback cascade, so it's \"okay\" to return an unhandled promise there. This may\n    // cause an unhandled promise rejection warning, but that's not a big deal.\n    //\n    // eslint-disable-next-line @typescript-eslint/no-misused-promises\n    host.afterProgramCreate = (builderProgram) => {\n      const emitResult = this.consumeProgram(builderProgram.getProgram(), host.getDefaultLibLocation!());\n\n      for (const diag of emitResult.diagnostics.filter((d) => d.code === JSII_DIAGNOSTICS_CODE)) {\n        utils.logDiagnostic(diag, this.projectRoot);\n      }\n\n      if (orig) {\n        orig.call(host, builderProgram);\n      }\n      if (opts?.compilationComplete) {\n        opts.compilationComplete(emitResult);\n      }\n    };\n    const watch = ts.createWatchProgram(host);\n\n    if (opts?.nonBlocking) {\n      // In non-blocking mode, returns the handle to the TypeScript watch interface.\n      return watch;\n    }\n    // In blocking mode, returns a never-resolving promise.\n    return new Promise<never>(() => null);\n  }\n\n  /**\n   * Prepares the project for build, by creating the necessary configuration\n   * file(s), and assigning the relevant root file(s).\n   *\n   * @param files the files that were specified as input in the CLI invocation.\n   */\n  private configureTypeScript(): TypeScriptConfig {\n    if (this.userProvidedTypeScriptConfig) {\n      const config = this.readTypeScriptConfig();\n\n      // emit a warning if validation is disabled\n      const rules = this.options.validateTypeScriptConfig ?? TypeScriptConfigValidationRuleSet.NONE;\n      if (rules === TypeScriptConfigValidationRuleSet.NONE) {\n        utils.logDiagnostic(\n          JsiiDiagnostic.JSII_4009_DISABLED_TSCONFIG_VALIDATION.create(undefined, this.configPath),\n          this.projectRoot,\n        );\n      }\n\n      // validate the user provided config\n      if (rules !== TypeScriptConfigValidationRuleSet.NONE) {\n        const configName = path.relative(this.projectRoot, this.configPath);\n        try {\n          const validator = new TypeScriptConfigValidator(rules);\n          validator.validate({\n            ...config,\n            // convert the internal format to the user format which is what the validator operates on\n            compilerOptions: convertForJson(config.compilerOptions),\n          });\n        } catch (error: unknown) {\n          if (error instanceof ValidationError) {\n            utils.logDiagnostic(\n              JsiiDiagnostic.JSII_4000_FAILED_TSCONFIG_VALIDATION.create(\n                undefined,\n                configName,\n                rules,\n                error.violations,\n              ),\n              this.projectRoot,\n            );\n          }\n\n          throw new utils.JsiiError(\n            `Failed validation of tsconfig \"compilerOptions\" in \"${configName}\" against rule set \"${rules}\"!`,\n          );\n        }\n      }\n\n      return config;\n    }\n\n    // generated config if none is provided by the user\n    return this.buildTypeScriptConfig();\n  }\n\n  /**\n   * Final preparations of the project for build.\n   *\n   * These are preparations that either\n   * - must happen immediately before the build, or\n   * - can be different for every build like assigning the relevant root file(s).\n   *\n   * @param files the files that were specified as input in the CLI invocation.\n   */\n  private prepareForBuild(...files: string[]) {\n    if (!this.userProvidedTypeScriptConfig) {\n      this.writeTypeScriptConfig();\n    }\n\n    this.rootFiles = this.determineSources(files);\n  }\n\n  /**\n   * Do a single build\n   */\n  private buildOnce(): ts.EmitResult {\n    if (!this.compilerHost.getDefaultLibLocation) {\n      throw new Error('No default library location was found on the TypeScript compiler host!');\n    }\n\n    const tsconf = this.tsconfig!;\n\n    const prog = ts.createIncrementalProgram({\n      rootNames: this.rootFiles.concat(_pathOfLibraries(tsconf.compilerOptions, this.compilerHost)),\n      options: tsconf.compilerOptions,\n      // Make the references absolute for the compiler\n      projectReferences: tsconf.references?.map((ref) => ({\n        path: path.resolve(path.dirname(this.configPath), ref.path),\n      })),\n      host: this.compilerHost,\n    });\n\n    return this.consumeProgram(prog.getProgram(), this.compilerHost.getDefaultLibLocation());\n  }\n\n  private consumeProgram(program: ts.Program, stdlib: string): ts.EmitResult {\n    const diagnostics = [...ts.getPreEmitDiagnostics(program)];\n    let hasErrors = false;\n\n    if (!hasErrors && this.diagsHaveAbortableErrors(diagnostics)) {\n      hasErrors = true;\n      LOG.error('Compilation errors prevented the JSII assembly from being created');\n    }\n\n    // Do the \"Assembler\" part first because we need some of the analysis done in there\n    // to post-process the AST\n    const assembler = new Assembler(this.options.projectInfo, this.system, program, stdlib, {\n      stripDeprecated: this.options.stripDeprecated,\n      stripDeprecatedAllowListFile: this.options.stripDeprecatedAllowListFile,\n      addDeprecationWarnings: this.options.addDeprecationWarnings,\n      compressAssembly: this.options.compressAssembly,\n    });\n\n    try {\n      const assmEmit = assembler.emit();\n      if (!hasErrors && (assmEmit.emitSkipped || this.diagsHaveAbortableErrors(assmEmit.diagnostics))) {\n        hasErrors = true;\n        LOG.error('Type model errors prevented the JSII assembly from being created');\n      }\n\n      diagnostics.push(...assmEmit.diagnostics);\n    } catch (e: any) {\n      diagnostics.push(JsiiDiagnostic.JSII_9997_UNKNOWN_ERROR.createDetached(e));\n      hasErrors = true;\n    }\n\n    // Do the emit, but add in transformers which are going to replace real\n    // comments with synthetic ones.\n    const emit = program.emit(\n      undefined, // targetSourceFile\n      undefined, // writeFile\n      undefined, // cancellationToken\n      undefined, // emitOnlyDtsFiles\n      assembler.customTransformers,\n    );\n    diagnostics.push(...emit.diagnostics);\n\n    if (!hasErrors && (emit.emitSkipped || this.diagsHaveAbortableErrors(emit.diagnostics))) {\n      hasErrors = true;\n      LOG.error('Compilation errors prevented the JSII assembly from being created');\n    }\n\n    // Some extra validation on the config.\n    // Make sure that { \"./.warnings.jsii.js\": \"./.warnings.jsii.js\" } is in the set of\n    // exports, if they are specified.\n    if (this.options.addDeprecationWarnings && this.options.projectInfo.exports !== undefined) {\n      const expected = `./${WARNINGSCODE_FILE_NAME}`;\n      const warningsExport = Object.entries(this.options.projectInfo.exports).filter(\n        ([k, v]) => k === expected && v === expected,\n      );\n\n      if (warningsExport.length === 0) {\n        hasErrors = true;\n        diagnostics.push(JsiiDiagnostic.JSII_0007_MISSING_WARNINGS_EXPORT.createDetached());\n      }\n    }\n\n    return {\n      emitSkipped: hasErrors,\n      diagnostics: ts.sortAndDeduplicateDiagnostics(diagnostics),\n      emittedFiles: emit.emittedFiles,\n    };\n  }\n\n  /**\n   * Build the TypeScript config object from jsii config\n   *\n   * This is the object that will be written to disk\n   * unless an existing tsconfig was provided.\n   */\n  private buildTypeScriptConfig(): TypeScriptConfig {\n    let references: string[] | undefined;\n\n    const isComposite =\n      this.options.projectReferences !== undefined\n        ? this.options.projectReferences\n        : this.options.projectInfo.projectReferences !== undefined\n        ? this.options.projectInfo.projectReferences\n        : false;\n    if (isComposite) {\n      references = this.findProjectReferences();\n    }\n\n    const pi = this.options.projectInfo;\n\n    return {\n      compilerOptions: {\n        ...pi.tsc,\n        ...BASE_COMPILER_OPTIONS,\n        // Enable composite mode if project references are enabled\n        composite: isComposite,\n        // When incremental, configure a tsbuildinfo file\n        tsBuildInfoFile: path.join(pi.tsc?.outDir ?? '.', 'tsconfig.tsbuildinfo'),\n      },\n      include: [pi.tsc?.rootDir != null ? path.join(pi.tsc.rootDir, '**', '*.ts') : path.join('**', '*.ts')],\n      exclude: [\n        'node_modules',\n        ...(pi.excludeTypescript ?? []),\n        ...(pi.tsc?.outDir != null &&\n        (pi.tsc?.rootDir == null || path.resolve(pi.tsc.outDir).startsWith(path.resolve(pi.tsc.rootDir) + path.sep))\n          ? [path.join(pi.tsc.outDir, '**', '*.ts')]\n          : []),\n      ],\n      // Change the references a little. We write 'originalpath' to the\n      // file under the 'path' key, which is the same as what the\n      // TypeScript compiler does. Make it relative so that the files are\n      // movable. Not strictly required but looks better.\n      references: references?.map((p) => ({ path: p })),\n    };\n  }\n\n  /**\n   * Load the TypeScript config object from a provided file\n   */\n  private readTypeScriptConfig(): TypeScriptConfig {\n    const projectRoot = this.options.projectInfo.projectRoot;\n    const { config, error } = ts.readConfigFile(this.configPath, ts.sys.readFile);\n    if (error) {\n      utils.logDiagnostic(error, projectRoot);\n      throw new utils.JsiiError(`Failed to load tsconfig at ${this.configPath}`);\n    }\n    const extended = ts.parseJsonConfigFileContent(config, ts.sys, projectRoot);\n    // the tsconfig parser adds this in, but it is not an expected compilerOption\n    delete extended.options.configFilePath;\n\n    return {\n      compilerOptions: extended.options,\n      watchOptions: extended.watchOptions,\n      include: extended.fileNames,\n    };\n  }\n\n  /**\n   * Creates a `tsconfig.json` file to improve the IDE experience.\n   *\n   * @return the fully qualified path to the `tsconfig.json` file\n   */\n  private writeTypeScriptConfig(): void {\n    const commentKey = '_generated_by_jsii_';\n    const commentValue = 'Generated by jsii - safe to delete, and ideally should be in .gitignore';\n\n    (this.tsconfig as any)[commentKey] = commentValue;\n\n    if (fs.existsSync(this.configPath)) {\n      const currentConfig = JSON.parse(fs.readFileSync(this.configPath, 'utf-8'));\n      if (!(commentKey in currentConfig)) {\n        throw new utils.JsiiError(\n          `A '${this.configPath}' file that was not generated by jsii is in ${this.options.projectInfo.projectRoot}. Aborting instead of overwriting.`,\n        );\n      }\n    }\n\n    const outputConfig = {\n      ...this.tsconfig,\n      compilerOptions: convertForJson(this.tsconfig?.compilerOptions),\n    };\n\n    LOG.debug(`Creating or updating ${chalk.blue(this.configPath)}`);\n    fs.writeFileSync(this.configPath, JSON.stringify(outputConfig, null, 2), 'utf8');\n  }\n\n  /**\n   * Find all dependencies that look like TypeScript projects.\n   *\n   * Enumerate all dependencies, if they have a tsconfig.json file with\n   * \"composite: true\" we consider them project references.\n   *\n   * (Note: TypeScript seems to only correctly find transitive project references\n   * if there's an \"index\" tsconfig.json of all projects somewhere up the directory\n   * tree)\n   */\n  private findProjectReferences(): string[] {\n    const pkg = this.options.projectInfo.packageJson;\n\n    const ret = new Array<string>();\n\n    const dependencyNames = new Set<string>();\n    for (const dependencyMap of [pkg.dependencies, pkg.devDependencies, pkg.peerDependencies]) {\n      if (dependencyMap === undefined) {\n        continue;\n      }\n      for (const name of Object.keys(dependencyMap)) {\n        dependencyNames.add(name);\n      }\n    }\n\n    for (const tsconfigFile of Array.from(dependencyNames).map((depName) => this.findMonorepoPeerTsconfig(depName))) {\n      if (!tsconfigFile) {\n        continue;\n      }\n\n      const { config: tsconfig } = ts.readConfigFile(tsconfigFile, this.system.readFile);\n\n      // Add references to any TypeScript package we find that is 'composite' enabled.\n      // Make it relative.\n      if (tsconfig.compilerOptions?.composite) {\n        ret.push(path.relative(this.options.projectInfo.projectRoot, path.dirname(tsconfigFile)));\n      } else {\n        // Not a composite package--if this package is in a node_modules directory, that is most\n        // likely correct, otherwise it is most likely an error (heuristic here, I don't know how to\n        // properly check this).\n        if (tsconfigFile.includes('node_modules')) {\n          LOG.warn('%s: not a composite TypeScript package, but it probably should be', path.dirname(tsconfigFile));\n        }\n      }\n    }\n\n    return ret;\n  }\n\n  /**\n   * Find source files using the same mechanism that the TypeScript compiler itself uses.\n   *\n   * Respects includes/excludes/etc.\n   *\n   * This makes it so that running 'typescript' and running 'jsii' has the same behavior.\n   */\n  private determineSources(files: string[]): string[] {\n    // explicitly requested files\n    if (files.length > 0) {\n      return [...files];\n    }\n\n    // for user provided config we already have parsed the full list of files\n    if (this.userProvidedTypeScriptConfig) {\n      return [...(this.tsconfig.include ?? [])];\n    }\n\n    // finally get the file list for the generated config\n    const parseConfigHost = parseConfigHostFromCompilerHost(this.compilerHost);\n    const parsed = ts.parseJsonConfigFileContent(this.tsconfig, parseConfigHost, this.options.projectInfo.projectRoot);\n    return [...parsed.fileNames];\n  }\n\n  /**\n   * Resolve the given dependency name from the current package, and find the associated tsconfig.json location\n   *\n   * Because we have the following potential directory layout:\n   *\n   *   package/node_modules/some_dependency\n   *   package/tsconfig.json\n   *\n   * We resolve symlinks and only find a \"TypeScript\" dependency if doesn't have 'node_modules' in\n   * the path after resolving symlinks (i.e., if it's a peer package in the same monorepo).\n   *\n   * Returns undefined if no such tsconfig could be found.\n   */\n  private findMonorepoPeerTsconfig(depName: string): string | undefined {\n    // eslint-disable-next-line @typescript-eslint/no-require-imports,@typescript-eslint/no-var-requires\n    const { builtinModules } = require('node:module');\n    if ((builtinModules ?? []).includes(depName)) {\n      // Can happen for modules like 'punycode' which are declared as dependency for polyfill purposes\n      return undefined;\n    }\n\n    try {\n      const depDir = findDependencyDirectory(depName, this.options.projectInfo.projectRoot);\n\n      const dep = path.join(depDir, 'tsconfig.json');\n      if (!fs.existsSync(dep)) {\n        return undefined;\n      }\n\n      // Resolve symlinks, to check if this is a monorepo peer\n      const dependencyRealPath = fs.realpathSync(dep);\n      if (dependencyRealPath.split(path.sep).includes('node_modules')) {\n        return undefined;\n      }\n\n      return dependencyRealPath;\n    } catch (e: any) {\n      // @types modules cannot be required, for example\n      if (['MODULE_NOT_FOUND', 'ERR_PACKAGE_PATH_NOT_EXPORTED'].includes(e.code)) {\n        return undefined;\n      }\n      throw e;\n    }\n  }\n\n  private diagsHaveAbortableErrors(diags: readonly ts.Diagnostic[]) {\n    return diags.some(\n      (d) =>\n        d.category === ts.DiagnosticCategory.Error ||\n        (this.options.failOnWarnings && d.category === ts.DiagnosticCategory.Warning),\n    );\n  }\n}\n\n/**\n * Options for Watch in non-blocking mode.\n *\n * @internal\n */\nexport interface NonBlockingWatchOptions {\n  /**\n   * Signals non-blocking execution\n   */\n  readonly nonBlocking: true;\n\n  /**\n   * Configures the diagnostics reporter\n   */\n  readonly reportDiagnostics: ts.DiagnosticReporter;\n\n  /**\n   * Configures the watch status reporter\n   */\n  readonly reportWatchStatus: ts.WatchStatusReporter;\n\n  /**\n   * This hook gets invoked when a compilation cycle (complete with Assembler execution) completes.\n   */\n  readonly compilationComplete: (emitResult: ts.EmitResult) => void;\n}\n\nfunction _pathOfLibraries(options: ts.CompilerOptions, host: ts.CompilerHost | ts.WatchCompilerHost<any>): string[] {\n  // Prefer user libraries, falling back to a library based on the target if not supplied by the user.\n  // This matches tsc behavior.\n  const libs = options.lib ?? [ts.getDefaultLibFileName(options)];\n  if (libs.length === 0) {\n    return [];\n  }\n\n  const libDir = host.getDefaultLibLocation?.();\n  if (!libDir) {\n    throw new Error(`Compiler host doesn't have a default library directory available for ${libs.join(', ')}`);\n  }\n  return libs.map((name) => path.join(libDir, name));\n}\n\nfunction parseConfigHostFromCompilerHost(host: ts.CompilerHost): ts.ParseConfigHost {\n  // Copied from upstream\n  // https://github.com/Microsoft/TypeScript/blob/9e05abcfd3f8bb3d6775144ede807daceab2e321/src/compiler/program.ts#L3105\n  return {\n    fileExists: (f) => host.fileExists(f),\n    readDirectory(root, extensions, excludes, includes, depth) {\n      if (host.readDirectory === undefined) {\n        throw new Error(\"'CompilerHost.readDirectory' must be implemented to correctly process 'projectReferences'\");\n      }\n      return host.readDirectory(root, extensions, excludes, includes, depth);\n    },\n    readFile: (f) => host.readFile(f),\n    useCaseSensitiveFileNames: host.useCaseSensitiveFileNames(),\n    trace: host.trace ? (s) => host.trace!(s) : undefined,\n  };\n}\n"]}