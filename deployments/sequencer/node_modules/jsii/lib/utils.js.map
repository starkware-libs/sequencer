{"version":3,"file":"utils.js","sourceRoot":"","sources":["../src/utils.ts"],"names":[],"mappings":"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","sourcesContent":["import * as log4js from 'log4js';\nimport * as ts from 'typescript';\n\nimport { JsiiDiagnostic } from './jsii-diagnostic';\n\n/**\n * Name of the logger for cli errors\n */\nexport const CLI_LOGGER = 'jsii/cli';\n/**\n * Name of the logger for diagnostics information\n */\nexport const DIAGNOSTICS = 'diagnostics';\n/**\n * Diagnostic code for JSII-generated messages.\n */\nexport const JSII_DIAGNOSTICS_CODE = 9999;\n\n/**\n * Obtains the relevant logger to be used for a given diagnostic message.\n *\n * @param logger     the ``log4js.Logger`` to use for emitting the message.\n * @param diagnostic the message for which a logger is requested.\n *\n * @returns a logger method of the ``logger`` for the appropriate level.\n */\nexport function diagnosticsLogger(\n  logger: log4js.Logger,\n  diagnostic: ts.Diagnostic,\n): ((message: any, ...args: any[]) => void) | undefined {\n  switch (diagnostic.category) {\n    case ts.DiagnosticCategory.Error:\n      if (!logger.isErrorEnabled()) {\n        return undefined;\n      }\n      return logger.error.bind(logger);\n    case ts.DiagnosticCategory.Warning:\n      if (!logger.isWarnEnabled()) {\n        return undefined;\n      }\n      return logger.warn.bind(logger);\n    case ts.DiagnosticCategory.Message:\n      if (!logger.isDebugEnabled()) {\n        return undefined;\n      }\n      return logger.debug.bind(logger);\n    case ts.DiagnosticCategory.Suggestion:\n    default:\n      if (!logger.isTraceEnabled()) {\n        return undefined;\n      }\n      return logger.trace.bind(logger);\n  }\n}\n\n/**\n * Formats a diagnostic message with color and context, if possible.\n *\n * @param diagnostic  the diagnostic message ot be formatted.\n * @param projectRoot the root of the TypeScript project.\n *\n * @returns a formatted string.\n */\nexport function formatDiagnostic(diagnostic: ts.Diagnostic, projectRoot: string) {\n  if (JsiiDiagnostic.isJsiiDiagnostic(diagnostic)) {\n    // Ensure we leverage pre-rendered diagnostics where available.\n    return diagnostic.format(projectRoot);\n  }\n  return _formatDiagnostic(diagnostic, projectRoot);\n}\n\n/**\n * Formats a diagnostic message with color and context, if possible. Users\n * should use `formatDiagnostic` instead, as this implementation is intended for\n * internal usafe only.\n *\n * @param diagnostic  the diagnostic message ot be formatted.\n * @param projectRoot the root of the TypeScript project.\n *\n * @returns a formatted string.\n */\nexport function _formatDiagnostic(diagnostic: ts.Diagnostic, projectRoot: string) {\n  const formatDiagnosticsHost: ts.FormatDiagnosticsHost = {\n    getCurrentDirectory: () => projectRoot,\n    getCanonicalFileName: (fileName) => fileName,\n    getNewLine: () => ts.sys.newLine,\n  };\n\n  const message =\n    diagnostic.file != null\n      ? ts.formatDiagnosticsWithColorAndContext([diagnostic], formatDiagnosticsHost)\n      : ts.formatDiagnostic(diagnostic, formatDiagnosticsHost);\n\n  if (!JsiiDiagnostic.isJsiiDiagnostic(diagnostic)) {\n    return message;\n  }\n\n  // This is our own diagnostics, so we'll format appropriately (replacing TS#### with JSII####).\n  return message.replace(` TS${JSII_DIAGNOSTICS_CODE}: `, ` JSII${diagnostic.jsiiCode}: `);\n}\n\nexport function logDiagnostic(diagnostic: ts.Diagnostic, projectRoot: string) {\n  const logFunc = diagnosticsLogger(log4js.getLogger(DIAGNOSTICS), diagnostic);\n  if (!logFunc) {\n    return;\n  }\n  logFunc(formatDiagnostic(diagnostic, projectRoot).trim());\n}\n\nconst PERSON_REGEX = /^\\s*(.+?)(?:\\s*<([^>]+)>)?(?:\\s*\\(([^)]+)\\))?\\s*$/;\n/**\n * Parses a string-formatted person entry from `package.json`.\n * @param value the string-formatted person entry.\n *\n * @example\n *  parsePerson(\"Barney Rubble <b@rubble.com> (http://barnyrubble.tumblr.com/)\");\n *  // => { name: \"Barney Rubble\", email: \"b@rubble.com\", url: \"http://barnyrubble.tumblr.com/\" }\n */\nexport function parsePerson(value: string) {\n  const match = PERSON_REGEX.exec(value);\n  if (!match) {\n    throw new JsiiError(`Invalid stringified \"person\" value: ${value}`);\n  }\n  const [, name, email, url] = match;\n  const result: { name: string; email?: string; url?: string } = {\n    name: name.trim(),\n  };\n  if (email) {\n    result.email = email.trim();\n  }\n  if (url) {\n    result.url = url.trim();\n  }\n  return result;\n}\n\nconst REPOSITORY_REGEX = /^(?:(github|gist|bitbucket|gitlab):)?([A-Za-z\\d_-]+\\/[A-Za-z\\d_-]+)$/;\nexport function parseRepository(value: string): { url: string } {\n  const match = REPOSITORY_REGEX.exec(value);\n  if (!match) {\n    return { url: value };\n  }\n  const [, host, slug] = match;\n  switch (host ?? 'github') {\n    case 'github':\n      return { url: `https://github.com/${slug}.git` };\n    case 'gist':\n      return { url: `https://gist.github.com/${slug}.git` };\n    case 'bitbucket':\n      return { url: `https://bitbucket.org/${slug}.git` };\n    case 'gitlab':\n      return { url: `https://gitlab.com/${slug}.git` };\n    default:\n      throw new JsiiError(`Unknown repository hosting service: ${host}`);\n  }\n}\n\nconst ANSI_REGEX =\n  // eslint-disable-next-line no-control-regex\n  /[\\u001b\\u009b][[()#;?]*(?:[0-9]{1,4}(?:;[0-9]{0,4})*)?[0-9A-ORZcf-nqry=><]/g;\n\nexport function stripAnsi(x: string): string {\n  return x.replace(ANSI_REGEX, '');\n}\n\n/**\n * Maps the provided type to stip all `readonly` modifiers from its properties.\n */\nexport type Mutable<T> = { -readonly [K in keyof T]: Mutable<T[K]> };\n\n/**\n * Throws an error that is intended as CLI output.\n */\nexport class JsiiError extends Error {\n  /**\n   * An expected error that can be nicely formatted where needed (e.g. in CLI output)\n   * This should only be used for errors that a user can fix themselves.\n   *\n   * @param message The error message to be printed to the user.\n   * @param showHelp Print the help before the error.\n   */\n  constructor(public override readonly message: string, public readonly showHelp = false) {\n    super(message);\n    Object.setPrototypeOf(this, JsiiError.prototype);\n  }\n}\n"]}