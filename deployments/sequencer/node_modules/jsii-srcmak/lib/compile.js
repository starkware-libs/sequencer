"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.compile = compile;
const crypto = __importStar(require("crypto"));
const path = __importStar(require("path"));
const fs = __importStar(require("fs-extra"));
const util_1 = require("./util");
const compilerModule = require.resolve('jsii/bin/jsii');
/**
 * Compiles the source files in `workdir` with jsii.
 */
async function compile(workdir, options) {
    var _a, _b, _c, _d;
    (0, util_1.validateOptions)(options);
    const args = ['--silence-warnings', 'reserved-word'];
    const entrypoint = (_a = options.entrypoint) !== null && _a !== void 0 ? _a : 'index.ts';
    if (path.extname(entrypoint) !== '.ts') {
        throw new Error(`jsii entrypoint must be a .ts file: ${entrypoint}`);
    }
    if (!(await fs.pathExists(path.join(workdir, entrypoint)))) {
        throw new Error(`unable to find typescript entrypoint: ${path.join(workdir, entrypoint)}`);
    }
    // path to entrypoint without extension
    const basepath = path.join(path.dirname(entrypoint), path.basename(entrypoint, '.ts'));
    const moduleKey = (_c = (_b = options.moduleKey) === null || _b === void 0 ? void 0 : _b.replace(/\./g, '').replace(/\//g, '')) !== null && _c !== void 0 ? _c : crypto.createHash('sha256').update(basepath, 'utf8').digest('hex');
    // jsii modules to include
    const moduleDirs = (_d = options.deps) !== null && _d !== void 0 ? _d : [];
    const targets = {};
    const deps = {};
    for (const dir of moduleDirs) {
        // read module metadata
        const metadata = await fs.readJson(path.join(dir, 'package.json'));
        const moduleName = metadata.name;
        const moduleVersion = metadata.version;
        const targetdir = path.join(path.join(workdir, 'node_modules'), moduleName);
        await fs.mkdirp(path.dirname(targetdir));
        await fs.copy(dir, targetdir);
        // add to "deps" and "peer deps"
        if (!moduleName.startsWith('@types/')) {
            deps[moduleName] = moduleVersion;
        }
    }
    const pkg = {
        name: moduleKey,
        version: '0.0.0',
        author: 'generated@generated.com',
        main: `${basepath}.js`,
        types: `${basepath}.d.ts`,
        license: 'UNLICENSED',
        repository: { url: 'http://generated', type: 'git' },
        jsii: {
            outdir: 'dist',
            targets: targets,
        },
        dependencies: deps,
        peerDependencies: deps,
    };
    if (options.exports) {
        pkg.exports = options.exports;
    }
    if (options.python) {
        targets.python = {
            distName: 'generated',
            module: options.python.moduleName,
        };
    }
    if (options.java) {
        targets.java = {
            package: options.java.package,
            maven: {
                groupId: 'generated',
                artifactId: 'generated',
            },
        };
    }
    if (options.csharp) {
        targets.dotnet = {
            namespace: options.csharp.namespace,
            packageId: options.csharp.namespace,
        };
    }
    if (options.golang) {
        targets.go = {
            moduleName: options.golang.moduleName,
            packageName: options.golang.packageName,
        };
    }
    await fs.writeFile(path.join(workdir, 'package.json'), JSON.stringify(pkg, undefined, 2));
    await (0, util_1.exec)(compilerModule, args, {
        cwd: workdir,
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcGlsZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9jb21waWxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFXQSwwQkFrR0M7QUE3R0QsK0NBQWlDO0FBQ2pDLDJDQUE2QjtBQUM3Qiw2Q0FBK0I7QUFFL0IsaUNBQStDO0FBRS9DLE1BQU0sY0FBYyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUM7QUFFeEQ7O0dBRUc7QUFDSSxLQUFLLFVBQVUsT0FBTyxDQUFDLE9BQWUsRUFBRSxPQUFnQjs7SUFDN0QsSUFBQSxzQkFBZSxFQUFDLE9BQU8sQ0FBQyxDQUFDO0lBRXpCLE1BQU0sSUFBSSxHQUFHLENBQUMsb0JBQW9CLEVBQUUsZUFBZSxDQUFDLENBQUM7SUFDckQsTUFBTSxVQUFVLEdBQUcsTUFBQSxPQUFPLENBQUMsVUFBVSxtQ0FBSSxVQUFVLENBQUM7SUFFcEQsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxLQUFLLEtBQUssRUFBRSxDQUFDO1FBQ3ZDLE1BQU0sSUFBSSxLQUFLLENBQUMsdUNBQXVDLFVBQVUsRUFBRSxDQUFDLENBQUM7SUFDdkUsQ0FBQztJQUVELElBQUksQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxVQUFVLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUMzRCxNQUFNLElBQUksS0FBSyxDQUFDLHlDQUF5QyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxVQUFVLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDN0YsQ0FBQztJQUVELHVDQUF1QztJQUN2QyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxVQUFVLEVBQUUsS0FB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QU8sQ0FBQyxNQUFNLENBQUMsU0FBUztZQUNuQyxTQUFTLEVBQUUsT0FBTyxDQUFDLE1BQU0sQ0FBQyxTQUFTO1NBQ3BDLENBQUM7SUFDSixDQUFDO0lBRUQsSUFBSSxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDbkIsT0FBTyxDQUFDLEVBQUUsR0FBRztZQUNYLFVBQVUsRUFBRSxPQUFPLENBQUMsTUFBTSxDQUFDLFVBQVU7WUFDckMsV0FBVyxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsV0FBVztTQUN4QyxDQUFDO0lBQ0osQ0FBQztJQUVELE1BQU0sRUFBRSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxjQUFjLENBQUMsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUUxRixNQUFNLElBQUEsV0FBSSxFQUFDLGNBQWMsRUFBRSxJQUFJLEVBQUU7UUFDL0IsR0FBRyxFQUFFLE9BQU87S0FDYixDQUFDLENBQUM7QUFDTCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY3J5cHRvIGZyb20gJ2NyeXB0byc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IHsgT3B0aW9ucyB9IGZyb20gJy4vb3B0aW9ucyc7XG5pbXBvcnQgeyBleGVjLCB2YWxpZGF0ZU9wdGlvbnMgfSBmcm9tICcuL3V0aWwnO1xuXG5jb25zdCBjb21waWxlck1vZHVsZSA9IHJlcXVpcmUucmVzb2x2ZSgnanNpaS9iaW4vanNpaScpO1xuXG4vKipcbiAqIENvbXBpbGVzIHRoZSBzb3VyY2UgZmlsZXMgaW4gYHdvcmtkaXJgIHdpdGgganNpaS5cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNvbXBpbGUod29ya2Rpcjogc3RyaW5nLCBvcHRpb25zOiBPcHRpb25zKSB7XG4gIHZhbGlkYXRlT3B0aW9ucyhvcHRpb25zKTtcblxuICBjb25zdCBhcmdzID0gWyctLXNpbGVuY2Utd2FybmluZ3MnLCAncmVzZXJ2ZWQtd29yZCddO1xuICBjb25zdCBlbnRyeXBvaW50ID0gb3B0aW9ucy5lbnRyeXBvaW50ID8/ICdpbmRleC50cyc7XG5cbiAgaWYgKHBhdGguZXh0bmFtZShlbnRyeXBvaW50KSAhPT0gJy50cycpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYGpzaWkgZW50cnlwb2ludCBtdXN0IGJlIGEgLnRzIGZpbGU6ICR7ZW50cnlwb2ludH1gKTtcbiAgfVxuXG4gIGlmICghKGF3YWl0IGZzLnBhdGhFeGlzdHMocGF0aC5qb2luKHdvcmtkaXIsIGVudHJ5cG9pbnQpKSkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYHVuYWJsZSB0byBmaW5kIHR5cGVzY3JpcHQgZW50cnlwb2ludDogJHtwYXRoLmpvaW4od29ya2RpciwgZW50cnlwb2ludCl9YCk7XG4gIH1cblxuICAvLyBwYXRoIHRvIGVudHJ5cG9pbnQgd2l0aG91dCBleHRlbnNpb25cbiAgY29uc3QgYmFzZXBhdGggPSBwYXRoLmpvaW4ocGF0aC5kaXJuYW1lKGVudHJ5cG9pbnQpLCBwYXRoLmJhc2VuYW1lKGVudHJ5cG9pbnQsICcudHMnKSk7XG5cbiAgY29uc3QgbW9kdWxlS2V5ID0gb3B0aW9ucy5tb2R1bGVLZXk/LnJlcGxhY2UoL1xcLi9nLCAnJykucmVwbGFjZSgvXFwvL2csICcnKSA/PyBjcnlwdG8uY3JlYXRlSGFzaCgnc2hhMjU2JykudXBkYXRlKGJhc2VwYXRoLCAndXRmOCcpLmRpZ2VzdCgnaGV4Jyk7XG5cbiAgLy8ganNpaSBtb2R1bGVzIHRvIGluY2x1ZGVcbiAgY29uc3QgbW9kdWxlRGlycyA9IG9wdGlvbnMuZGVwcyA/PyBbXTtcblxuICBjb25zdCB0YXJnZXRzOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0geyB9O1xuXG4gIGNvbnN0IGRlcHM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7IH07XG5cbiAgZm9yIChjb25zdCBkaXIgb2YgbW9kdWxlRGlycykge1xuICAgIC8vIHJlYWQgbW9kdWxlIG1ldGFkYXRhXG4gICAgY29uc3QgbWV0YWRhdGEgPSBhd2FpdCBmcy5yZWFkSnNvbihwYXRoLmpvaW4oZGlyLCAncGFja2FnZS5qc29uJykpO1xuICAgIGNvbnN0IG1vZHVsZU5hbWU6IHN0cmluZyA9IG1ldGFkYXRhLm5hbWU7XG4gICAgY29uc3QgbW9kdWxlVmVyc2lvbjogc3RyaW5nID0gbWV0YWRhdGEudmVyc2lvbjtcblxuICAgIGNvbnN0IHRhcmdldGRpciA9IHBhdGguam9pbihwYXRoLmpvaW4od29ya2RpciwgJ25vZGVfbW9kdWxlcycpLCBtb2R1bGVOYW1lKTtcbiAgICBhd2FpdCBmcy5ta2RpcnAocGF0aC5kaXJuYW1lKHRhcmdldGRpcikpO1xuICAgIGF3YWl0IGZzLmNvcHkoZGlyLCB0YXJnZXRkaXIpO1xuXG4gICAgLy8gYWRkIHRvIFwiZGVwc1wiIGFuZCBcInBlZXIgZGVwc1wiXG4gICAgaWYgKCFtb2R1bGVOYW1lLnN0YXJ0c1dpdGgoJ0B0eXBlcy8nKSkge1xuICAgICAgZGVwc1ttb2R1bGVOYW1lXSA9IG1vZHVsZVZlcnNpb247XG4gICAgfVxuICB9XG5cbiAgY29uc3QgcGtnID0ge1xuICAgIG5hbWU6IG1vZHVsZUtleSxcbiAgICB2ZXJzaW9uOiAnMC4wLjAnLFxuICAgIGF1dGhvcjogJ2dlbmVyYXRlZEBnZW5lcmF0ZWQuY29tJyxcbiAgICBtYWluOiBgJHtiYXNlcGF0aH0uanNgLFxuICAgIHR5cGVzOiBgJHtiYXNlcGF0aH0uZC50c2AsXG4gICAgbGljZW5zZTogJ1VOTElDRU5TRUQnLFxuICAgIHJlcG9zaXRvcnk6IHsgdXJsOiAnaHR0cDovL2dlbmVyYXRlZCcsIHR5cGU6ICdnaXQnIH0sXG4gICAganNpaToge1xuICAgICAgb3V0ZGlyOiAnZGlzdCcsXG4gICAgICB0YXJnZXRzOiB0YXJnZXRzLFxuICAgIH0sXG4gICAgZGVwZW5kZW5jaWVzOiBkZXBzLFxuICAgIHBlZXJEZXBlbmRlbmNpZXM6IGRlcHMsXG4gIH07XG5cbiAgaWYgKG9wdGlvbnMuZXhwb3J0cykge1xuICAgIChwa2cgYXMgUmVjb3JkPHN0cmluZywgYW55PikuZXhwb3J0cyA9IG9wdGlvbnMuZXhwb3J0cztcbiAgfVxuXG4gIGlmIChvcHRpb25zLnB5dGhvbikge1xuICAgIHRhcmdldHMucHl0aG9uID0ge1xuICAgICAgZGlzdE5hbWU6ICdnZW5lcmF0ZWQnLFxuICAgICAgbW9kdWxlOiBvcHRpb25zLnB5dGhvbi5tb2R1bGVOYW1lLFxuICAgIH07XG4gIH1cblxuICBpZiAob3B0aW9ucy5qYXZhKSB7XG4gICAgdGFyZ2V0cy5qYXZhID0ge1xuICAgICAgcGFja2FnZTogb3B0aW9ucy5qYXZhLnBhY2thZ2UsXG4gICAgICBtYXZlbjoge1xuICAgICAgICBncm91cElkOiAnZ2VuZXJhdGVkJyxcbiAgICAgICAgYXJ0aWZhY3RJZDogJ2dlbmVyYXRlZCcsXG4gICAgICB9LFxuICAgIH07XG4gIH1cblxuICBpZiAob3B0aW9ucy5jc2hhcnApIHtcbiAgICB0YXJnZXRzLmRvdG5ldCA9IHtcbiAgICAgIG5hbWVzcGFjZTogb3B0aW9ucy5jc2hhcnAubmFtZXNwYWNlLFxuICAgICAgcGFja2FnZUlkOiBvcHRpb25zLmNzaGFycC5uYW1lc3BhY2UsXG4gICAgfTtcbiAgfVxuXG4gIGlmIChvcHRpb25zLmdvbGFuZykge1xuICAgIHRhcmdldHMuZ28gPSB7XG4gICAgICBtb2R1bGVOYW1lOiBvcHRpb25zLmdvbGFuZy5tb2R1bGVOYW1lLFxuICAgICAgcGFja2FnZU5hbWU6IG9wdGlvbnMuZ29sYW5nLnBhY2thZ2VOYW1lLFxuICAgIH07XG4gIH1cblxuICBhd2FpdCBmcy53cml0ZUZpbGUocGF0aC5qb2luKHdvcmtkaXIsICdwYWNrYWdlLmpzb24nKSwgSlNPTi5zdHJpbmdpZnkocGtnLCB1bmRlZmluZWQsIDIpKTtcblxuICBhd2FpdCBleGVjKGNvbXBpbGVyTW9kdWxlLCBhcmdzLCB7XG4gICAgY3dkOiB3b3JrZGlyLFxuICB9KTtcbn1cbiJdfQ==