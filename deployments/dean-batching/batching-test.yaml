apiVersion: batch/v1
kind: Job
metadata:
  name: dean-batching-test
  namespace: dean-batching
spec:
  backoffLimit: 0
  template:
    metadata:
      labels:
        app: dean-batching-test
    spec:
      restartPolicy: Never
      nodeSelector:
        role: "apollo-core-service-c4d-standard-8"
      tolerations:
        - key: key
          operator: "Equal"
          value: "apollo-core-service-c4d-standard-8"
          effect: "NoSchedule"
      initContainers:
      - name: fix-permissions
        image: busybox
        command: ["sh", "-c", "mkdir -p /data/workspace && chmod -R 777 /data/workspace && echo 'Permissions fixed!'"]
        volumeMounts:
        - name: data
          mountPath: /data
      containers:
      - name: test
        image: ghcr.io/starkware-libs/sequencer/sequencer:dean-k8s_batching_test-fd3d4f1
        workingDir: /data/workspace
        command: ["/bin/bash", "-c"]
        env:
        - name: RUST_LOG
          value: info
        - name: BLOCKS_TO_SYNC
          value: "200000"
        - name: BATCH_SIZE
          value: "1000"
        - name: PATH
          value: /app/target/release:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
        args:
        - |
          set -e
          
          echo "========================================="
          echo "DEAN'S BATCHING TEST: 0 â†’ 200K"
          echo "========================================="
          echo ""
          echo "Using test_batching.sh script (same approach as deploy_batching_test.sh)"
          echo ""
          
          # Copy test script from ConfigMap
          cp /test-scripts/test_batching.sh .
          chmod +x test_batching.sh
          
          # Run the test script
          ./test_batching.sh 2>&1 | tee test_output.log
          
          echo ""
          echo "========================================="
          echo "TEST COMPLETE"
          echo "========================================="
        resources:
          requests:
            cpu: "7"
            memory: "16Gi"
          limits:
            cpu: "16"
            memory: "32Gi"
        volumeMounts:
        - name: data
          mountPath: /data
        - name: configs
          mountPath: /configs
          readOnly: true
        - name: test-scripts
          mountPath: /test-scripts
          readOnly: true
      volumes:
      - name: data
        persistentVolumeClaim:
          claimName: dean-hyperdisk-pvc
      - name: configs
        configMap:
          name: sequencer-configs
      - name: test-scripts
        configMap:
          name: dean-test-scripts
