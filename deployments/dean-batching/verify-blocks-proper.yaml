apiVersion: batch/v1
kind: Job
metadata:
  name: verify-blocks-proper
  namespace: dean-batching
spec:
  backoffLimit: 0
  template:
    metadata:
      labels:
        app: verify-blocks-proper
    spec:
      restartPolicy: Never
      nodeSelector:
        role: "apollo-core-service-c4d-standard-8"
      tolerations:
        - key: key
          operator: "Equal"
          value: "apollo-core-service-c4d-standard-8"
          effect: "NoSchedule"
      initContainers:
      - name: setup
        image: busybox
        command: ["sh", "-c", "chmod -R 777 /workspace"]
        volumeMounts:
        - name: workspace
          mountPath: /workspace
      containers:
      - name: verify
        image: rust:1.75
        workingDir: /build
        command: ["/bin/bash", "-c"]
        args:
          - |
            set -e
            
            echo "========================================="
            echo "BLOCK-LEVEL DATA VERIFICATION"
            echo "========================================="
            echo ""
            
            # Check databases exist
            if [ ! -d "/workspace/data_with_batching/SN_MAIN" ]; then
              echo "ERROR: WITH batching database not found!"
              exit 1
            fi
            
            if [ ! -d "/workspace/data_without_batching/SN_MAIN" ]; then
              echo "ERROR: WITHOUT batching database not found!"
              exit 1
            fi
            
            echo "âœ“ Both databases found"
            echo ""
            
            # Clone sequencer repo to get apollo_storage
            echo "Cloning sequencer repository..."
            git clone --depth 1 --branch dean/k8s_batching_test https://github.com/starkware-libs/sequencer.git
            cd sequencer
            
            # Copy our verification program
            mkdir -p crates/apollo_storage/examples
            cp /verify-src/verify_blocks.rs crates/apollo_storage/examples/
            
            echo ""
            echo "Compiling verification program..."
            echo "(This may take 5-10 minutes on first run)"
            echo ""
            
            # Compile and run
            cd crates/apollo_storage
            cargo run --example verify_blocks --features rand --release -- /workspace
            
            echo ""
            echo "========================================="
            echo "VERIFICATION COMPLETE"
            echo "========================================="
        resources:
          requests:
            cpu: "4"
            memory: "8Gi"
          limits:
            cpu: "8"
            memory: "16Gi"
        volumeMounts:
        - name: workspace
          mountPath: /workspace
        - name: verify-source
          mountPath: /verify-src
      volumes:
      - name: workspace
        persistentVolumeClaim:
          claimName: dean-hyperdisk-pvc
      - name: verify-source
        configMap:
          name: verify-blocks-source

