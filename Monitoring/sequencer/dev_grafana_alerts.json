{
  "alerts": [
    {
      "name": "consensus_block_number_stuck",
      "title": "Consensus block number stuck",
      "ruleGroup": "consensus",
      "expr": "changes(consensus_block_number{cluster=~\"$cluster\", namespace=~\"$namespace\"}[30s])",
      "conditions": [
        {
          "evaluator": {
            "params": [
              2.0
            ],
            "type": "lt"
          },
          "operator": {
            "type": "and"
          },
          "reducer": {
            "params": [],
            "type": "avg"
          },
          "type": "query"
        }
      ],
      "for": "1s",
      "intervalSec": 10,
      "severity": "p2"
    },
    {
      "name": "consensus_build_proposal_failed",
      "title": "Consensus build proposal failed",
      "ruleGroup": "consensus",
      "expr": "rate(consensus_build_proposal_failed{cluster=~\"$cluster\", namespace=~\"$namespace\"}[1m])",
      "conditions": [
        {
          "evaluator": {
            "params": [
              0.0
            ],
            "type": "gt"
          },
          "operator": {
            "type": "and"
          },
          "reducer": {
            "params": [],
            "type": "avg"
          },
          "type": "query"
        }
      ],
      "for": "10s",
      "intervalSec": 20,
      "severity": "p3"
    },
    {
      "name": "consensus_validate_proposal_failed",
      "title": "Consensus validate proposal failed",
      "ruleGroup": "consensus",
      "expr": "rate(consensus_proposals_invalid{cluster=~\"$cluster\", namespace=~\"$namespace\"}[1h])",
      "conditions": [
        {
          "evaluator": {
            "params": [
              0.001388888888888889
            ],
            "type": "gt"
          },
          "operator": {
            "type": "and"
          },
          "reducer": {
            "params": [],
            "type": "avg"
          },
          "type": "query"
        }
      ],
      "for": "1m",
      "intervalSec": 20,
      "severity": "p3"
    },
    {
      "name": "consensus_votes_num_sent_messages",
      "title": "Consensus votes num sent messages",
      "ruleGroup": "consensus",
      "expr": "rate(apollo_consensus_votes_num_sent_messages{cluster=~\"$cluster\", namespace=~\"$namespace\"}[20m])",
      "conditions": [
        {
          "evaluator": {
            "params": [
              0.027777777777777776
            ],
            "type": "lt"
          },
          "operator": {
            "type": "and"
          },
          "reducer": {
            "params": [],
            "type": "avg"
          },
          "type": "query"
        }
      ],
      "for": "1m",
      "intervalSec": 20,
      "severity": "p4"
    },
    {
      "name": "consensus_decisions_reached_by_consensus_stuck",
      "title": "Consensus decisions reached by consensus stuck",
      "ruleGroup": "consensus",
      "expr": "rate(consensus_decisions_reached_by_consensus{cluster=~\"$cluster\", namespace=~\"$namespace\"}[20m])",
      "conditions": [
        {
          "evaluator": {
            "params": [
              1.0
            ],
            "type": "lt"
          },
          "operator": {
            "type": "and"
          },
          "reducer": {
            "params": [],
            "type": "avg"
          },
          "type": "query"
        }
      ],
      "for": "1m",
      "intervalSec": 20,
      "severity": "p4"
    },
    {
      "name": "consensus_inbound_stream_evicted",
      "title": "Consensus inbound stream evicted",
      "ruleGroup": "consensus",
      "expr": "rate(consensus_inbound_stream_evicted{cluster=~\"$cluster\", namespace=~\"$namespace\"}[1h])",
      "conditions": [
        {
          "evaluator": {
            "params": [
              0.001388888888888889
            ],
            "type": "gt"
          },
          "operator": {
            "type": "and"
          },
          "reducer": {
            "params": [],
            "type": "avg"
          },
          "type": "query"
        }
      ],
      "for": "1m",
      "intervalSec": 20,
      "severity": "p4"
    },
    {
      "name": "cende_write_prev_height_blob_latency_too_high",
      "title": "Cende write prev height blob latency too high",
      "ruleGroup": "consensus",
      "expr": "avg_over_time(cende_write_prev_height_blob_latency{cluster=~\"$cluster\", namespace=~\"$namespace\"}[20m])",
      "conditions": [
        {
          "evaluator": {
            "params": [
              1.5
            ],
            "type": "gt"
          },
          "operator": {
            "type": "and"
          },
          "reducer": {
            "params": [],
            "type": "avg"
          },
          "type": "query"
        }
      ],
      "for": "1m",
      "intervalSec": 20,
      "severity": "p4"
    },
    {
      "name": "gateway_add_tx_rate_drop",
      "title": "Gateway add_tx rate drop",
      "ruleGroup": "gateway",
      "expr": "sum(rate(gateway_transactions_received{cluster=~\"$cluster\", namespace=~\"$namespace\"}[20m])) or vector(0)",
      "conditions": [
        {
          "evaluator": {
            "params": [
              0.1
            ],
            "type": "lt"
          },
          "operator": {
            "type": "and"
          },
          "reducer": {
            "params": [],
            "type": "avg"
          },
          "type": "query"
        }
      ],
      "for": "1m",
      "intervalSec": 20,
      "severity": "p2"
    },
    {
      "name": "gateway_add_tx_latency_increase",
      "title": "Gateway avg add_tx latency increase",
      "ruleGroup": "gateway",
      "expr": "sum(rate(gateway_add_tx_latency_sum{cluster=~\"$cluster\", namespace=~\"$namespace\"}[1m]))/sum(rate(gateway_add_tx_latency_count{cluster=~\"$cluster\", namespace=~\"$namespace\"}[1m]))",
      "conditions": [
        {
          "evaluator": {
            "params": [
              2.0
            ],
            "type": "gt"
          },
          "operator": {
            "type": "and"
          },
          "reducer": {
            "params": [],
            "type": "avg"
          },
          "type": "query"
        }
      ],
      "for": "1m",
      "intervalSec": 20,
      "severity": "p2"
    },
    {
      "name": "mempool_add_tx_rate_drop",
      "title": "Mempool add_tx rate drop",
      "ruleGroup": "mempool",
      "expr": "sum(rate(mempool_transactions_received{cluster=~\"$cluster\", namespace=~\"$namespace\"}[20m])) or vector(0)",
      "conditions": [
        {
          "evaluator": {
            "params": [
              0.1
            ],
            "type": "lt"
          },
          "operator": {
            "type": "and"
          },
          "reducer": {
            "params": [],
            "type": "avg"
          },
          "type": "query"
        }
      ],
      "for": "1m",
      "intervalSec": 20,
      "severity": "p2"
    },
    {
      "name": "mempool_get_txs_size_drop",
      "title": "Mempool get_txs size drop",
      "ruleGroup": "mempool",
      "expr": "avg_over_time(mempool_get_txs_size{cluster=~\"$cluster\", namespace=~\"$namespace\"}[20m])",
      "conditions": [
        {
          "evaluator": {
            "params": [
              0.01
            ],
            "type": "lt"
          },
          "operator": {
            "type": "and"
          },
          "reducer": {
            "params": [],
            "type": "avg"
          },
          "type": "query"
        }
      ],
      "for": "1m",
      "intervalSec": 20,
      "severity": "p2"
    },
    {
      "name": "http_server_idle",
      "title": "http server idle",
      "ruleGroup": "http_server",
      "expr": "rate(max(http_server_added_transactions_total{cluster=~\"$cluster\", namespace=~\"$namespace\"})[60m:])",
      "conditions": [
        {
          "evaluator": {
            "params": [
              1e-6
            ],
            "type": "lt"
          },
          "operator": {
            "type": "and"
          },
          "reducer": {
            "params": [],
            "type": "avg"
          },
          "type": "query"
        }
      ],
      "for": "5m",
      "intervalSec": 60,
      "severity": "p2"
    },
    {
      "name": "mempool_pool_size_increase",
      "title": "Mempool pool size increase",
      "ruleGroup": "mempool",
      "expr": "mempool_pool_size{cluster=~\"$cluster\", namespace=~\"$namespace\"}",
      "conditions": [
        {
          "evaluator": {
            "params": [
              2000.0
            ],
            "type": "gt"
          },
          "operator": {
            "type": "and"
          },
          "reducer": {
            "params": [],
            "type": "avg"
          },
          "type": "query"
        }
      ],
      "for": "1m",
      "intervalSec": 20,
      "severity": "p2"
    },
    {
      "name": "consensus_round_high_avg",
      "title": "Consensus round high average",
      "ruleGroup": "consensus",
      "expr": "avg_over_time(consensus_round{cluster=~\"$cluster\", namespace=~\"$namespace\"}[10m])",
      "conditions": [
        {
          "evaluator": {
            "params": [
              0.2
            ],
            "type": "gt"
          },
          "operator": {
            "type": "and"
          },
          "reducer": {
            "params": [],
            "type": "avg"
          },
          "type": "query"
        }
      ],
      "for": "1m",
      "intervalSec": 20,
      "severity": "p2"
    }
  ]
}
